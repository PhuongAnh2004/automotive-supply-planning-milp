# Multi-Level Supply Planning for Automotive Parts — MILP Buy-vs-Make and Container Optimization

This project builds a **Mixed-Integer Linear Programming (MILP)** model to solve a multi-level supply planning problem for an automotive manufacturer.

In plain words, the model answers questions like:

- **How many finished goods (FG)** should we produce each month to cover the **sales forecast**, without exceeding **production capacity**?
- For each **L1 component**, how much should we **buy from suppliers** vs. **make in-house** (using L2 materials)?
- For each **L2 material**, how much should we **order from suppliers**, respecting **minimum order quantities (MOQ)** and **container sizes**?
- How do we do all of this while **minimizing total cost** (purchase + logistics + taxes + inventory holding), and avoiding too much leftover stock?

More concretely, the model includes:

- **FG (Finished Goods)**  
  - Monthly production decisions under **capacity constraints**  
  - Must satisfy the **demand plan (forecast)** for each month and FG code  

- **L1 (Intermediate components)**  
  - Can be **purchased** (from external suppliers) and/or **manufactured in-house** from L2  
  - Decisions: how much L1 to **buy vs. make** each month for each item
  - L1 is consumed by FG according to a BOM (bill of materials)

- **L2 (Raw materials)**  
  - Only **purchased** from suppliers  
  - L2 is consumed when manufacturing L1 (also via a BOM)  

- **Logistics & import cost**  
  - Purchases are grouped into **integer containers** (you can’t book 2.3 containers; only 2 or 3)  
  - Each container has:
    - `units_per_container`
    - `container_cost`
  - Import cost uses a **tax/insurance multiplier**:
    - Insurance (%)
    - Import duty (%)
    - VAT (%)
  - Total import cost = **(cargo value + logistics cost) × (1 + insurance) × (1 + duty) × (1 + VAT)**

- **MOQ (Minimum Order Quantity)**  
  - Some items must be ordered either **0** or at least **MOQ units** in a month  
  - This is modeled with **binary variables**:
    - If you order, you must order ≥ MOQ  
    - If you don’t order, quantity = 0  

- **Holding cost (inventory carrying cost)**  
  - Inventory held at the **end of each month** incurs a cost  
  - Assumed **20% per year**, converted to a **monthly rate** in the model  
  - Applied to:
    - FG inventory
    - L1 inventory
    - L2 inventory  

Overall, this is a **3-level planning problem** (FG–L1–L2) with:

- **Integer decisions** on:
  - buy quantities,
  - make quantities,
  - BOM-based consumption,
  - containers,
  - MOQ order flags;
- **Capacity constraints** at FG;
- **Inventory balance** across periods;
- **Realistic logistics and tax structure** on imports.

The MILP model finds a plan that:

- Meets all monthly FG demands,
- Respects FG capacity, MOQ, and container integer constraints,
- Uses L1 and L2 flows consistent with an integer BOM,
- And **minimizes total cost** (purchasing + logistics + taxes + holding).

The repository includes a provided Excel input (`data/input.xlsx`) and a sample output (`outputs/output.xlsx`) so reviewers can inspect results immediately.  
Running the code reproduces an output workbook with the same tabs.

---

## Repo structure

```text
.
├─ src/
│  ├─ io_excel.py      # read/write Excel (input/output)
│  ├─ model.py         # MILP model (PuLP)
│  ├─ utils.py         # parsing/cleaning helpers
│  └─ run.py           # CLI runner (read -> solve -> write)
│
├─ data/
│  └─ input.xlsx       # provided input for testing/repro
│
├─ outputs/
│  └─ output.xlsx      # sample output (generated by the model)
│
├─ requirements.txt
├─ README.md
└─ NOTICE.md           # dataset attribution / usage notes

```

## Model overview 

### Decision variables 

All decisions are made per item and per month.

#### FG level
- `prod_fg[fg, month]` — FG production quantity (continuous)
- `inv_fg[fg, month]` — FG ending inventory (continuous)

#### L1 level
- `buy_l1[l1, month]` — purchased L1 quantity (**integer**)
- `cont_l1[l1, month]` — booked containers for L1 (**integer**)
- `make_l1[l1, month]` — manufactured L1 quantity (**integer**)
- `inv_l1[l1, month]` — L1 ending inventory (continuous)

#### L2 level
- `buy_l2[l2, month]` — purchased L2 quantity (**integer**)
- `cont_l2[l2, month]` — booked containers for L2 (**integer**)
- `inv_l2[l2, month]` — L2 ending inventory (continuous)

#### Consumption (integer consumption enforced)
- `cons_l1[l1, month]` — L1 consumed by FG production (**integer**)
- `cons_l2[l2, month]` — L2 consumed by L1 manufacturing (**integer**)

#### MOQ binary flags
- `order_l1[l1, month]` — 1 if ordering L1 in that month, else 0
- `order_l2[l2, month]` — 1 if ordering L2 in that month, else 0

---

## Core constraints

### 1) Demand fulfillment + inventory balance (FG)
For each FG and month:
- ending inventory = opening inventory + production − demand
- production ≤ capacity

### 2) BOM-based consumption (integer)
For each month:
- L1 consumption = Σ (BOM_FG_L1 qty_int × FG production)
- L2 consumption = Σ (BOM_L1_L2 qty_int × L1 make)

> **Important:** Because `cons_l1` and `cons_l2` are integer, the model requires **integer BOM quantities**.

### 3) Inventory balance (L1 & L2)
- L1 ending inventory = opening inv + buy + make − consumption
- L2 ending inventory = opening inv + buy − consumption

### 4) Container booking (integer containers)
- buy_qty ≤ containers_booked × units_per_container

This allows partial utilization (unused capacity is reported in the output).

### 5) MOQ logic (buy = 0 OR buy ≥ MOQ)
Using binary variable `order_*`:
- buy ≥ MOQ × order
- buy ≤ BigM × order

---

## Objective function (minimize total cost)

The model minimizes:
1) Purchase total cost (cargo + logistics) × tax multiplier  
2) Holding cost for inventories (monthly carrying cost)

### Purchase cost per item per month

Let:
- `Q` = buy quantity
- `C` = containers booked
- `m` = unit material cost
- `cc` = container cost
- `ins` = insurance rate (decimal)
- `duty` = import duty rate (decimal)
- `vat` = VAT rate (decimal)

Then:
- Cargo value = `m × Q`
- Logistics cost = `cc × C`
- Tax multiplier = `(1 + ins) × (1 + duty) × (1 + vat)`
- Purchase total = `(cargo value + logistics cost) × tax multiplier`

### Holding cost (monthly)

Let:
- `h` = annual holding rate (default 20%/year)
- monthly holding rate = `h / 12`

Then:
- holding cost = `ending_inventory × (monthly holding rate × unit material cost)`

---

## Input file format (`data/input.xlsx`)

The model reads the following sheets:

### `DEMAND_FG`
- `month`
- `fg_code`
- `demand_qty` (**must be integer**)

### `CAP_FG`
- `fg_code`
- `cap_fg_per_month`

### `BOM_FG_L1`
Required columns (either naming is accepted):
- `fg_code` or `fg_code (Product Item Code)`
- `l1_code` or `l1_code (Assembly Code)`
- `qty_per_fg` or `qty_per_fg (Quantity)`  
**Must be integer (or integer-like)**

### `BOM_L1_L2`
Required columns:
- `l1_code` or `l1_code (Parent Code)`
- `l2_code` or `l2_code (Assembly Code)`
- `qty_per_l1` or `qty_per_l1 (Quantity)`  
**Must be integer (or integer-like)**

### `INV_START`
- `item_code`
- `on_hand_qty`  
(Used for **L2 starting inventory**; FG and L1 default to 0 unless change parameters)

### `ITEM_MASTER`
- `item_code`
- `unit_material_cost`
- `units_per_container`
- `moq` (optional; if missing, treated as 0)

### `COST_BUY_MONTHLY`
- `month`
- `item_code`
- `unit_material_cost`
- `units_per_container`
- `container_cost`
- `insurance` (can be `%` string or decimal)
- `import_duty` (can be `%` string or decimal)
- `VAT` (can be `%` string or decimal)

> If monthly cost fields are missing for a specific `(month, item)`, the model falls back to values in `ITEM_MASTER` when relevant.

---

## Outputs (`outputs/output.xlsx`)

The code generates an Excel workbook with these sheets:

### `FG_PLAN`
- `month, fg_code`
- `opening_inv_fg`
- `produce_qty`
- `demand_qty`
- `ending_inv_fg`

### `L1_PLAN`
- `month, l1_code`
- `opening_inv_l1`
- `buy_qty`
- `containers_booked`
- `unused_container_capacity_qty`
- `make_qty`
- `consumption_l1`
- `ending_inv_l1`

### `L2_PLAN`
- `month, l2_code`
- `opening_inv_l2`
- `buy_qty`
- `containers_booked`
- `unused_container_capacity_qty`
- `consumption_l2`
- `ending_inv_l2`

### `COST_SUMMARY`
Month-level totals:
- `cargo_value`
- `logistics_cost`
- `purchase_total_cost`
- `holding_cost`
- `grand_total_cost`
- `containers_booked`

### `COST_DETAIL`
Item-level cost breakdown per month:
- `cargo_value`
- `logistics_cost`
- `tax_multiplier`
- `purchase_total_cost`
- `holding_cost`
- `grand_total_cost`

---

## How to run (local)

### 1) Install dependencies
```bash
python -m venv .venv
# Windows:
.venv\Scripts\activate
# macOS/Linux:
source .venv/bin/activate

pip install -r requirements.txt

```

### 2) Run with the provided input file

```bash
python src/run.py --input data/input.xlsx --output outputs/output_test.xlsx --solver_msg
```

This writes a new output file to:
- `outputs/output_test.xlsx`

---

## Notes & assumptions

Default starting inventories:
- `inv0_fg = 0`
- `inv0_l1 = 0`
- L2 start inventory is read from `INV_START`

Integer consumption requires integer BOM quantities.
- If BOM is fractional, scale units (e.g., multiply all BOM by 10) and adjust demand accordingly.

Solver settings:
- CBC via PuLP
- time limit: 180s (default)
- optimality gap: 1% (default)

---

## Data attribution
See `NOTICE.md` for dataset source and attribution/usage notes.

---

## Contact
- Author: Phuong-Anh Duong
- LinkedIn: `linkedin.com/in/phương-anh-dương-a97bb1259`
- Email: dphanhwork204@gmail.com

